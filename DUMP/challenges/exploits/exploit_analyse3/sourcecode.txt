//
//action.php
//i have changed the directory name where the sessions are stored (to xxxxx)
//

<?php
$database = "us3rd4tabase/s3cr3t.db";
$page     = "";

function alert_message(&$message, $page) {
    $script='<script type="text/javascript">';
    $script.=$message;
    $script.='window.location.href="'.$DOCUMENT_ROOT.'/challenges/exploits/exploit_analyse3/'.$page.'";';
    $script.='</script>';
    $html='<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"><html><head><title>Error!</title>'.$script.'</head><body bgcolor="#D0D0D0"></body></html>';
       echo $html;
    exit;
    }

function isvuser($accessid) {
    return (preg_match('/^[a-z0-9\x20]+$/i', $accessid) == TRUE);
    }
function isvpasswd($pin) {
    return (preg_match('/^[\;\?\.\-\_a-z0-9]+$/i', $pin) == TRUE);
    }

if ($HTTP_POST_VARS['action']=='log'){
  $page = "account.php";
  if(isset($HTTP_POST_VARS['accessid']) AND isset($HTTP_POST_VARS['pin'])){
     if (isvuser($HTTP_POST_VARS['accessid']) AND isvpasswd($HTTP_POST_VARS['pin'])){
      $con_file = file_get_contents($database);
      $md5_pin = md5($HTTP_POST_VARS['pin']);
      $datastring = $HTTP_POST_VARS['accessid']."::".$md5_pin;

      if(strpos($con_file, $datastring)){
          srand ((double)microtime()*1000000);
          $ran  = rand(0, 10);
          $ran  = $ran.rand(1000000000, 2000000000);
          $ran  = md5($ran).'='.$HTTP_POST_VARS['accessid'];

          fopen("xxxxxx/$ran", "w");
          header("Location:database.php?sessid=$ran");

        exit;
        }else{
          $message = 'alert("Error! Unknown accessid/pin!");';
          alert_message($message, $page);
          }
     }else{
        $message = 'alert("Error! You have used forbidden chars in your input!");';
        alert_message($message, $page);
       }
  }else{
    $message = 'alert("Error! We need your accessid and pin!");';
    alert_message($message, $page);
    }
}

//register
if ($HTTP_POST_VARS['action']=='reg'){
 $page = "register.php";
 if (isset($HTTP_POST_VARS['accessid']) AND isset($HTTP_POST_VARS['pin']) AND (strlen($HTTP_POST_VARS['accessid'])<=20) AND (strlen($HTTP_POST_VARS['pin']<=20))){
    if (isvuser($HTTP_POST_VARS['accessid']) AND isvpasswd($HTTP_POST_VARS['pin'])){

      $con_file = file_get_contents($database);
      if (strpos($con_file, ";::".$HTTP_POST_VARS['accessid'])){
        $message = 'alert("Sorry but a user with that username already exist!");';
        alert_message($message, $page);
        }
      $md5_passwd = md5($HTTP_POST_VARS['pin']);
      $hfile = fopen($database, "a");
      fputs($hfile, ";::".$HTTP_POST_VARS['accessid']."::".$md5_passwd."::;\n");
      fclose($hfile);
      $message = 'alert("You have been registered successfully!");';
      alert_message($message, $page);
      }else{
        $message = 'alert("Error! You have used forbidden chars in your input!");';
        alert_message($message, $page);
        }

  }else{
    $message = 'alert("Please fill in all the information needed and pay attention to the limits(user[20]|pass[20])!");';
    alert_message($message, $page);
    }

  $message = 'alert("Sorry but at the moment it is not possible to register!");';
  alert_message($message, $page);
}

if ($HTTP_GET_VARS['endsess']=='1'){
  if((preg_match("/^[a-zA-Z0-9=]+$/i", $HTTP_GET_VARS['sessid'])==true)){
    $session_file = "xxxxx/".$HTTP_GET_VARS['sessid'];

    if(unlink($session_file)==false){
      $page = "database.php";
      $message = 'alert("Error!");';
      alert_message($message, $page);
    }else{
      $page = "account.php";
      $message = 'alert("You are logged out!");';
      alert_message($message, $page);
      }
  }else{
  $page = "database.php";
  $message = 'alert("Error!");';
  alert_message($message, $page);
  }
}
?>

//
//database.php
//
//

<?php
if ((preg_match("/^[a-zA-Z0-9=]+$/i", $HTTP_GET_VARS['sessid'])!=true)){
  header("Location: account.php");
  exit;
}

if(!is_file("xxxxx/".$HTTP_GET_VARS['sessid']))){
  header("Location: account.php");
  exit;
}
?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Frameset//EN">
<html>
<head>
<title>Realistic Hacking Challenge Number IV</title>
<meta name="author" content="TheBlacksheep">
<meta name="generator" content="editor">
<meta name="copyright" content="Copyright (c) by theblacksheep">
<meta http-equiv="content-language" content="de,en">
<meta name="revisit-after" content="20 days">
<meta name="description" content="New (German and English-speaking) homepage with a Hacking-Challenge (PHP, JavaScript, Applets, Programming, Internet, Cryptology, Steganography, CrackIt's), tutorials and a forum">
<meta name="keywords" content="challenge,challenges,hacking,cracking,learn,tutorials,logic,hackits,applet,java,script,javascript,security,downloads,tools,internet,cracker,hacker,steganography,cryptology,hacks,theblacksheep,erik,geek,geeks,hacker,hackers,php,crackit,crackits,programming,password">
<link rel="stylesheet" type="text/css" href="formate.css">
<STYLE type=text/css media=all>CODE {FONT: 10px geneva, lucida, sans-serif}</STYLE>
</HEAD>
<BODY text=#000000 bgColor=#000000>
<DIV id=wrapper>
 <DIV id=content>
  <p class=superfine style="margin-top:10em;">
   <DIV style="BORDER-RIGHT: #333 1px dotted; PADDING-RIGHT: 5px; BORDER-TOP: #333 1px dotted;
     PADDING-LEFT: 5px; PADDING-BOTTOM: 5px; MARGIN: 0px auto; BORDER-LEFT: #333 1px dotted;
     WIDTH: 500px; PADDING-TOP: 5px; BORDER-BOTTOM: #333 1px dotted; BACKGROUND-COLOR: #cc9">

     <table>
       <tr>
       <td>This would be my protected page. Your name is

       <?php
         $info = preg_split("/=/i", $HTTP_GET_VARS['sessid']);
         echo '"'.$info[1].'"';
       ?>

       </td>
       </tr>
     </table>
<?php echo "<a href=\"action.php?endsess=1&sessid=".$HTTP_GET_VARS['sessid']."\">Leave this page</a>"; ?>
</DIV>
</p>
</DIV>
</DIV>

</BODY></HTML>
